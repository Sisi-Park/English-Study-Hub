<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>English Study Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script async crossorigin="anonymous" data-clerk-publishable-key="" src="https://cdn.jsdelivr.net/npm/@clerk/clerk-js@latest/dist/clerk.browser.js"></script>
    <style>
      :root {
        --bg: #f5f5f7;
        --surface: #ffffff;
        --border: #d2d2d7;
        --text: #1d1d1f;
        --muted: #6e6e73;
        --primary: #0071e3;
      }
      body {
        background: radial-gradient(circle at top, #ffffff 0%, var(--bg) 58%);
        color: var(--text);
        min-height: 100vh;
      }
      .panel {
        background: color-mix(in oklab, var(--surface), #ffffff 20%);
        border: 1px solid var(--border);
        border-radius: 20px;
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.05);
      }
      .hidden-route { display: none; }
    </style>
  </head>
  <body class="antialiased">
    <main class="max-w-6xl mx-auto px-4 py-8 md:py-12">
      <header class="mb-10 md:mb-14">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
          <div>
            <p class="text-sm text-gray-500 tracking-wide uppercase">English Study Hub</p>
            <h1 class="text-3xl md:text-5xl font-semibold mt-1">Learn English with clarity.</h1>
            <p class="mt-3 text-gray-600 max-w-2xl">Minimal, focused, Apple-style interface with AI-powered study tools.</p>
          </div>
          <div class="flex items-center gap-3">
            <div id="user-button"></div>
            <button id="logout-btn" class="hidden px-4 py-2 rounded-full text-sm border border-gray-300 hover:bg-gray-100">Sign out</button>
          </div>
        </div>
      </header>

      <section id="auth-landing" class="panel p-8 md:p-10 mb-8">
        <div class="grid md:grid-cols-2 gap-8 items-center">
          <div>
            <h2 class="text-2xl md:text-3xl font-semibold">Welcome back</h2>
            <p class="text-gray-600 mt-3">Sign in to continue your study streak and save all AI results to your Library.</p>
            <ul class="mt-5 space-y-2 text-sm text-gray-600 list-disc list-inside">
              <li>Search Words & Sentences</li>
              <li>I want to say</li>
              <li>Correct the error</li>
            </ul>
          </div>
          <div class="panel p-5">
            <p class="text-sm text-gray-500 mb-3">Authentication (Clerk)</p>
            <div id="sign-in"></div>
            <div id="auth-warning" class="text-sm text-amber-700 bg-amber-50 border border-amber-200 rounded-xl p-3 hidden"></div>
          </div>
        </div>
      </section>

      <section id="app-shell" class="hidden">
        <nav class="panel p-3 mb-6 overflow-x-auto">
          <div class="flex gap-2 min-w-max">
            <button data-route="dashboard" class="route-btn px-4 py-2 rounded-full bg-black text-white text-sm">Home</button>
            <button data-route="search" class="route-btn px-4 py-2 rounded-full border text-sm">Search Words & Sentences</button>
            <button data-route="say" class="route-btn px-4 py-2 rounded-full border text-sm">I want to say</button>
            <button data-route="correct" class="route-btn px-4 py-2 rounded-full border text-sm">Correct the error</button>
            <button data-route="result-search" class="route-btn px-4 py-2 rounded-full border text-sm">Result Search Words & Sentences</button>
            <button data-route="result-say" class="route-btn px-4 py-2 rounded-full border text-sm">Result I want to say</button>
            <button data-route="result-correct" class="route-btn px-4 py-2 rounded-full border text-sm">Result Correct the error</button>
            <button data-route="library" class="route-btn px-4 py-2 rounded-full border text-sm">Library</button>
          </div>
        </nav>

        <section id="dashboard" class="route panel p-8">
          <h2 class="text-2xl font-semibold">Your study dashboard</h2>
          <p class="text-gray-600 mt-2">Choose a section to get started. Every result is auto-saved in Library.</p>
          <div class="grid md:grid-cols-3 gap-4 mt-6">
            <button data-route="search" class="jump panel p-5 text-left hover:border-blue-400 transition">
              <p class="font-semibold">Search Words & Sentences</p>
              <p class="text-sm text-gray-600 mt-1">Vocabulary extraction + definitions.</p>
            </button>
            <button data-route="say" class="jump panel p-5 text-left hover:border-blue-400 transition">
              <p class="font-semibold">I want to say</p>
              <p class="text-sm text-gray-600 mt-1">Korean to natural English.</p>
            </button>
            <button data-route="correct" class="jump panel p-5 text-left hover:border-blue-400 transition">
              <p class="font-semibold">Correct the error</p>
              <p class="text-sm text-gray-600 mt-1">Grammar correction + explanation.</p>
            </button>
          </div>
        </section>

        <section id="search" class="route hidden-route panel p-8">
          <h2 class="text-2xl font-semibold">Search Words & Sentences</h2>
          <p class="text-gray-600 mt-2">Paste English text to extract key words.</p>
          <textarea id="search-input" rows="4" class="w-full mt-4 border rounded-2xl p-4" placeholder="Type words or a sentence..."></textarea>
          <button id="search-submit" class="mt-4 px-5 py-3 bg-blue-600 text-white rounded-xl">Generate result</button>
        </section>

        <section id="say" class="route hidden-route panel p-8">
          <h2 class="text-2xl font-semibold">I want to say</h2>
          <p class="text-gray-600 mt-2">Type Korean and get natural English options.</p>
          <textarea id="say-input" rows="4" class="w-full mt-4 border rounded-2xl p-4" placeholder="한국어를 입력하세요..."></textarea>
          <button id="say-submit" class="mt-4 px-5 py-3 bg-blue-600 text-white rounded-xl">Generate result</button>
        </section>

        <section id="correct" class="route hidden-route panel p-8">
          <h2 class="text-2xl font-semibold">Correct the error</h2>
          <p class="text-gray-600 mt-2">Fix grammar and clarity instantly.</p>
          <textarea id="correct-input" rows="4" class="w-full mt-4 border rounded-2xl p-4" placeholder="Type your English sentence..."></textarea>
          <button id="correct-submit" class="mt-4 px-5 py-3 bg-blue-600 text-white rounded-xl">Generate result</button>
        </section>

        <section id="result-search" class="route hidden-route panel p-8">
          <h2 class="text-2xl font-semibold">Result Search Words & Sentences</h2>
          <div id="result-search-content" class="mt-4 text-gray-700 whitespace-pre-wrap"></div>
        </section>

        <section id="result-say" class="route hidden-route panel p-8">
          <h2 class="text-2xl font-semibold">Result I want to say</h2>
          <div id="result-say-content" class="mt-4 text-gray-700 whitespace-pre-wrap"></div>
        </section>

        <section id="result-correct" class="route hidden-route panel p-8">
          <h2 class="text-2xl font-semibold">Result Correct the error</h2>
          <div id="result-correct-content" class="mt-4 text-gray-700 whitespace-pre-wrap"></div>
        </section>

        <section id="library" class="route hidden-route panel p-8">
          <div class="flex justify-between items-center gap-3 flex-wrap">
            <h2 class="text-2xl font-semibold">Library</h2>
            <input id="openai-key" type="password" class="border rounded-xl px-3 py-2 text-sm" placeholder="OpenAI API Key (saved locally)">
          </div>
          <p class="text-gray-600 mt-2">Results auto-saved by section.</p>

          <div class="grid md:grid-cols-3 gap-4 mt-6">
            <div class="panel p-4">
              <h3 class="font-semibold">Search Words & Sentences</h3>
              <ul id="lib-search" class="mt-3 text-sm space-y-2"></ul>
            </div>
            <div class="panel p-4">
              <h3 class="font-semibold">I want to say</h3>
              <ul id="lib-say" class="mt-3 text-sm space-y-2"></ul>
            </div>
            <div class="panel p-4">
              <h3 class="font-semibold">Correct the error</h3>
              <ul id="lib-correct" class="mt-3 text-sm space-y-2"></ul>
            </div>
          </div>
        </section>

        <p id="status" class="mt-4 text-sm text-gray-500"></p>
      </section>
    </main>

    <script>
      const storageKeys = {
        openAi: 'esh_openai_key',
        library: 'esh_library'
      };

      const state = {
        library: JSON.parse(localStorage.getItem(storageKeys.library) || '{"search":[],"say":[],"correct":[]}')
      };

      const routeIds = ['dashboard', 'search', 'say', 'correct', 'result-search', 'result-say', 'result-correct', 'library'];

      function setRoute(route) {
        routeIds.forEach(id => {
          document.getElementById(id).classList.toggle('hidden-route', id !== route);
        });
        document.querySelectorAll('.route-btn').forEach(btn => {
          const active = btn.dataset.route === route;
          btn.classList.toggle('bg-black', active);
          btn.classList.toggle('text-white', active);
        });
      }

      function renderLibrary() {
        const sections = [
          ['search', 'lib-search'],
          ['say', 'lib-say'],
          ['correct', 'lib-correct']
        ];

        sections.forEach(([key, elId]) => {
          const container = document.getElementById(elId);
          const items = state.library[key];
          container.innerHTML = items.length
            ? items.slice().reverse().map(item => `<li class="border rounded-lg p-2"><p class="font-medium">${item.input}</p><p class="text-gray-600 mt-1">${item.output.slice(0, 180)}...</p></li>`).join('')
            : '<li class="text-gray-400">No saved results.</li>';
        });
      }

      function persistLibrary() {
        localStorage.setItem(storageKeys.library, JSON.stringify(state.library));
        renderLibrary();
      }

      function setStatus(text) {
        document.getElementById('status').textContent = text;
      }

      async function callOpenAI(prompt) {
        const apiKey = localStorage.getItem(storageKeys.openAi) || '';
        if (!apiKey) throw new Error('Please add your OpenAI API key in Library first.');

        const response = await fetch('https://api.openai.com/v1/chat/completions', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            Authorization: `Bearer ${apiKey}`
          },
          body: JSON.stringify({
            model: 'gpt-4o-mini',
            temperature: 0.4,
            messages: [
              { role: 'system', content: 'You are a concise English study assistant.' },
              { role: 'user', content: prompt }
            ]
          })
        });

        if (!response.ok) {
          const err = await response.json().catch(() => ({}));
          throw new Error(err.error?.message || 'OpenAI request failed');
        }

        const data = await response.json();
        return data.choices?.[0]?.message?.content?.trim() || 'No result returned.';
      }

      async function processRequest(type, input, prompt, resultId, resultRoute) {
        if (!input.trim()) return setStatus('Please enter text first.');

        try {
          setStatus('Generating result...');
          const output = await callOpenAI(prompt(input));
          document.getElementById(resultId).textContent = output;

          state.library[type].push({ input, output, createdAt: new Date().toISOString() });
          persistLibrary();

          setStatus('Saved to Library.');
          setRoute(resultRoute);
        } catch (error) {
          setStatus(error.message);
        }
      }

      document.getElementById('search-submit').addEventListener('click', () =>
        processRequest(
          'search',
          document.getElementById('search-input').value,
          (input) => `Extract key English words from this text. For each word give definition, part of speech, and one simple example sentence. Text: ${input}`,
          'result-search-content',
          'result-search'
        )
      );

      document.getElementById('say-submit').addEventListener('click', () =>
        processRequest(
          'say',
          document.getElementById('say-input').value,
          (input) => `Translate this Korean text into natural English. Provide 3 tone options (casual, neutral, formal) and a one-line usage note for each: ${input}`,
          'result-say-content',
          'result-say'
        )
      );

      document.getElementById('correct-submit').addEventListener('click', () =>
        processRequest(
          'correct',
          document.getElementById('correct-input').value,
          (input) => `Correct grammar and awkward phrasing in this sentence. Return: corrected sentence, what changed, and why in simple terms: ${input}`,
          'result-correct-content',
          'result-correct'
        )
      );

      document.querySelectorAll('.route-btn, .jump').forEach(btn => {
        btn.addEventListener('click', () => setRoute(btn.dataset.route));
      });

      document.getElementById('openai-key').addEventListener('change', (e) => {
        localStorage.setItem(storageKeys.openAi, e.target.value.trim());
        setStatus('OpenAI key saved locally.');
      });

      async function initClerk() {
        const authWarning = document.getElementById('auth-warning');
        const publishableKey = window.CLERK_PUBLISHABLE_KEY || '';

        if (!window.Clerk || !publishableKey) {
          authWarning.classList.remove('hidden');
          authWarning.textContent = MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAzDx1ZIbCw9d6ujqKFnLp
MgZXUQF19MHZI1PJ5g3HosNGIRozwAdXZYU+YfNFHiWOVokznK4TaiCDP15a2aDw
Pk8fqujjdDiLfza+vi3ewd6lsmph7OCjAmgdebt+On8SRmiYYxSAFdl/0M2itHJI
SezLDvRm19kgCj61J0U4vi+1bdD9F2pviDxa95MHSG8kHeVzwHfBF/vRFnZuhYCL
Soj+QuKeIQ18ckdXDrK//qL1McLlHeWcTcaA0bMtksiXxJong/RMePA9Mbj9rHbe
UJfZnHzEgenfIktdnZagZZSE/OzVl0Aq5Fv4TM4PqJOfPCyNE347p9J4PEBPhwgu
AQIDAQAB;
          return;
        }

        await window.Clerk.load({ publishableKey });
        const signedIn = !!window.Clerk.user;

        if (!signedIn) {
          window.Clerk.mountSignIn(document.getElementById('sign-in'), {
            appearance: { elements: { card: 'shadow-none border border-gray-200 rounded-2xl' } }
          });
          return;
        }

        document.getElementById('auth-landing').classList.add('hidden');
        document.getElementById('app-shell').classList.remove('hidden');
        document.getElementById('logout-btn').classList.remove('hidden');

        window.Clerk.mountUserButton(document.getElementById('user-button'));

        document.getElementById('logout-btn').addEventListener('click', async () => {
          await window.Clerk.signOut();
          location.reload();
        });
      }

      function bootstrap() {
        document.getElementById('openai-key').value = localStorage.getItem(storageKeys.openAi) || '';
        renderLibrary();
        setRoute('dashboard');
        initClerk();
      }

      bootstrap();
    </script>
  </body>
</html>
